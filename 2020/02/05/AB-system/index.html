<html>
<head><meta name="generator" content="Hexo 3.9.0">
	
	<title>基于u-boot+linux平台打造A/B双系统启动和升级</title>
	<meta name="keywords" content="howar.cn">

    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
	   <link href="/css/main.css?v=3" rel="stylesheet" type="text/css">
    
        <script src="/js/util.js"></script>
        <script>
            if(isMobile()) {
                loadjscssfile('../css/mobile.css', 'css');
            } else {
                loadjscssfile('../css/desktop.css', 'css');
            }
        </script> 
    

    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">

    
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=3">
    
    
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-159646423-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>


<h2 class="title">基于u-boot+linux平台打造A/B双系统启动和升级</h2>
<!---
<div style="text-align:center;margin-top: -10px;">
<div class="article-category">
发表于2020年2月5日




 </div>
--->
</div>

<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总体方案介绍"><span class="toc-text">总体方案介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#系统分区"><span class="toc-text">系统分区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动流程"><span class="toc-text">启动流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#升级流程"><span class="toc-text">升级流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#方案实现"><span class="toc-text">方案实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#下载u-boot源码"><span class="toc-text">下载u-boot源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编译u-boot"><span class="toc-text">编译u-boot</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Image-rootfs下载"><span class="toc-text">Image/rootfs下载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#u-boot对双系统启动的支持"><span class="toc-text">u-boot对双系统启动的支持</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#增加相关环境变量"><span class="toc-text">增加相关环境变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#修改引导逻辑"><span class="toc-text">修改引导逻辑</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux上对修改u-boot环境变量的支持"><span class="toc-text">Linux上对修改u-boot环境变量的支持</span></a></li></ol></li></ol>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>对于嵌入式系统，通常使用u-boot引导Linux内核然后挂载文件系统的方式，一般都只有一个Linux内核和一个文件系统。这种平台如果考虑升级的话，一般只能对应用程序进行升级，如果想对系统进行升级，有可能会出现变砖的情况。对系统要求较高的系统，必须做完备的考虑，防止在刷写过程中变砖的出现。采用A/B系统备份更新的方案可以避免这种情况的出现；此外A/B系统备份更新的方案，还能防止因某个分区损坏等原因造成的系统无法启动的问题。</p>
<p>本方案以uboot(version:2018.07)和linux(version:4.19)为环境，在s32v234sbc硬件平台上实现。</p>
<h2 id="总体方案介绍"><a href="#总体方案介绍" class="headerlink" title="总体方案介绍"></a>总体方案介绍</h2><h3 id="系统分区"><a href="#系统分区" class="headerlink" title="系统分区"></a>系统分区</h3><p>A/B系统升级需要对存储器进行分区设计，支持双系统升级需要两对boot/rootfs分区，如下表所示：</p>
<table border="2" bordercolor="black" width="300" cellspacing="0" cellpadding="5">
   <tr>
      <td>bootloader</td>
      <td>裸扇区</td>
   </tr>
   <tr>
      <td>boot_a</td>
      <td rowspan="4"> 独立分区 </td>
   </tr>
   <tr>
      <td>rootfs_a</td>
   </tr>
   <tr>
      <td>boot_b</td>
   </tr>
   <tr>
      <td>rootfs_b</td>
   </tr>
</table>

<p>其中：</p>
<ul>
<li>bootloader分区烧录bootloader（如u-boot）</li>
<li>boot_a分区存放A系统的Image和dtb文件</li>
<li>rootfs_a分区存放A系统的文件系统文件</li>
<li>boot_b分区存放B系统的Image和dtb文件</li>
<li>rootfs_b分区存放B系统的文件系统文件</li>
</ul>
<h3 id="启动流程"><a href="#启动流程" class="headerlink" title="启动流程"></a>启动流程</h3><p>A/B系统的启动需要bootloader支持对双系统的引导，需要关注三个重要的场景：</p>
<ul>
<li>正常引导启动</li>
<li>当前分区引导启动异常时，需要重试</li>
<li>当前分区引导启动异常且重试最大次数（3次）仍然失败，则切换分区引导启动</li>
</ul>
<p>uboot在引导启动中时，实际上是使用”mmcpart”和”mmcroot”这两个环境变量来选择引导和加载的内核以及文件系统。为支持对双系统的引导且支持上述场景，需要增加环境变量：</p>
<ul>
<li>boot_attempt_count: 当前分区尝试引导次数</li>
<li>boot_fail_flag: 某一分区引导异常且重试最大次数（3次）后仍然失败</li>
<li>boot_bank: 当前启动分区标识</li>
</ul>
<p>启动逻辑如下图所示：</p>
<img src="/images/AB-system/uboot-boot.png" align="center">

<h3 id="升级流程"><a href="#升级流程" class="headerlink" title="升级流程"></a>升级流程</h3><p>基于系统分区和启动流程对A/B双系统的支持，可进行A/B更新刷写，具体的流程如下图所示：</p>
<img src="/images/AB-system/update-process.png" align="center">

<h2 id="方案实现"><a href="#方案实现" class="headerlink" title="方案实现"></a>方案实现</h2><h3 id="下载u-boot源码"><a href="#下载u-boot源码" class="headerlink" title="下载u-boot源码"></a>下载u-boot源码</h3><p>由于本方案需要修改并重新编译u-boot，所以首先需要下载u-boot源码。本文基于硬件平台s32v234sbc，NXP官方已经有对应u-boot仓库，因此只需要执行一下命令即可下载u-boot源码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://source.codeaurora.org/external/autobsps32/u-boot</span><br><span class="line">cd u-boot</span><br><span class="line">git checkout -b &lt;branch_name&gt; v2018.07_bsp22.0</span><br></pre></td></tr></table></figure>

<h3 id="编译u-boot"><a href="#编译u-boot" class="headerlink" title="编译u-boot"></a>编译u-boot</h3><p>下载并修改（修改方案如下文）后，需要重新编译u-boot，使用一下命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make ARCH=aarch64 CROSS_COMPILE=/opt/toolchain/aarch64/bin/aarch64-linux-gnu- s32v234sbc_defconfig</span><br><span class="line">make CROSS_COMPILE=/opt/toolchain/aarch64/bin/aarch64-linux-gnu-</span><br></pre></td></tr></table></figure>

<p>其中<code>/opt/toolchain/aarch64</code>为我本机存放交叉编译工具链的目录。</p>
<h3 id="Image-rootfs下载"><a href="#Image-rootfs下载" class="headerlink" title="Image/rootfs下载"></a>Image/rootfs下载</h3><p>本实验中所使用的Image/dtb/rootfs均从NXP官网下载。当然也可以下载源码或通过yocto进行编译。</p>
<h3 id="u-boot对双系统启动的支持"><a href="#u-boot对双系统启动的支持" class="headerlink" title="u-boot对双系统启动的支持"></a>u-boot对双系统启动的支持</h3><h4 id="增加相关环境变量"><a href="#增加相关环境变量" class="headerlink" title="增加相关环境变量"></a>增加相关环境变量</h4><p>如上文中提到，为支持对双系统的引导，需要增加环境变量：</p>
<ul>
<li>boot_attempt_count: 当前分区尝试引导次数</li>
<li>boot_fail_flag: 某一分区引导异常且重试最大次数（3次）后仍然失败</li>
<li>boot_bank: 当前启动分区标识</li>
</ul>
<p>具体实现中，需对文件<code>include/configs/s32.h</code>进行修改：</p>
<p>修改宏 <code>CONFIG_EXTRA_ENV_SETTINGS</code> ，在其末尾增加上述变量，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"boot_fail_flag=0\0"</span> \</span><br><span class="line"><span class="string">"boot_attempt_count=0\0"</span> \</span><br><span class="line"><span class="string">"boot_bank=0\0"</span></span><br></pre></td></tr></table></figure>

<h4 id="修改引导逻辑"><a href="#修改引导逻辑" class="headerlink" title="修改引导逻辑"></a>修改引导逻辑</h4><p>u-boot默认只支持对单系统的引导，为支持上述2.2节所述的启动流程，需对文件<code>include/configs/s32.h</code>进行修改：</p>
<ol>
<li><p>首先增加以下宏：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UPDATE_BOOT_PARAM_CMD <span class="meta-string">"echo Switch boot bank ...;"</span> \</span></span><br><span class="line">	<span class="string">"if test $&#123;boot_bank&#125; = 0; then "</span> \</span><br><span class="line">		<span class="string">"setenv mmcpart 1; "</span> \</span><br><span class="line">		<span class="string">"setenv mmcroot /dev/mmcblk0p2 rootwait rw; "</span> \</span><br><span class="line">	<span class="string">"else "</span> \</span><br><span class="line">		<span class="string">"setenv mmcpart 3; "</span> \</span><br><span class="line">		<span class="string">"setenv mmcroot /dev/mmcblk0p4 rootwait rw; "</span> \</span><br><span class="line">	<span class="string">"fi; "</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWITCH_BOOT_BANK_CMD <span class="meta-string">"echo Switch boot bank ...;"</span> \</span></span><br><span class="line">	<span class="string">"if test $&#123;boot_bank&#125; = 0; then "</span> \</span><br><span class="line">		<span class="string">"setenv boot_bank 1; "</span> \</span><br><span class="line">	<span class="string">"else "</span> \</span><br><span class="line">		<span class="string">"setenv boot_bank 0; "</span> \</span><br><span class="line">	<span class="string">"fi; "</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UPDATE_BOOT_ATTEMPT_COUNT_CMD <span class="meta-string">"echo Update boot attempt count $&#123;boot_attempt_count&#125; ...; "</span> \</span></span><br><span class="line">    <span class="string">"if test $&#123;boot_attempt_count&#125; = 0; then "</span> \</span><br><span class="line">	    <span class="string">"setenv boot_attempt_count 1; "</span> \</span><br><span class="line">	<span class="string">"else "</span> \</span><br><span class="line">	    <span class="string">"if test $&#123;boot_attempt_count&#125; = 1; then "</span> \</span><br><span class="line">		    <span class="string">"setenv boot_attempt_count 2; "</span> \</span><br><span class="line">		<span class="string">"else "</span> \</span><br><span class="line">		    <span class="string">"if test $&#123;boot_attempt_count&#125; = 2; then "</span> \</span><br><span class="line">		        <span class="string">"setenv boot_attempt_count 3; "</span> \</span><br><span class="line">			<span class="string">"else "</span> \</span><br><span class="line">                <span class="string">"if test $&#123;boot_fail_flag&#125; = 0; then "</span> \</span><br><span class="line">				    <span class="string">"setenv boot_fail_flag 1; "</span> \</span><br><span class="line">					<span class="string">"setenv boot_attempt_count 0; "</span> \</span><br><span class="line">					SWITCH_BOOT_BANK_CMD \</span><br><span class="line">					<span class="string">"saveenv; "</span> \</span><br><span class="line">			    <span class="string">"fi; "</span>	\</span><br><span class="line">			<span class="string">"fi; "</span>	\</span><br><span class="line">		<span class="string">"fi; "</span>	\</span><br><span class="line">	<span class="string">"fi; "</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SYSTEM_RESET_CMD \</span></span><br><span class="line">	<span class="string">"if test $&#123;boot_fail_flag&#125; != 1 || test $&#123;boot_attempt_count&#125; != 3; then "</span> \</span><br><span class="line">		<span class="string">"saveenv; "</span> \</span><br><span class="line">		<span class="string">"reset; "</span> \</span><br><span class="line">	<span class="string">"fi; "</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>u-boot引导实际使用宏 <code>CONFIG_BOOTCOMMAND</code> ，需对其进行修改：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_BOOTCOMMAND \</span></span><br><span class="line">	    <span class="string">"mmc dev $&#123;mmcdev&#125;; if mmc rescan; then "</span> \</span><br><span class="line">	       UPDATE_BOOT_ATTEMPT_COUNT_CMD \</span><br><span class="line">		   UPDATE_BOOT_PARAM_CMD \</span><br><span class="line">		   <span class="string">"if run loadimage; then "</span> \</span><br><span class="line">				<span class="string">"run mmcboot; "</span> \</span><br><span class="line">		   <span class="string">"else "</span> \</span><br><span class="line">		       SYSTEM_RESET_CMD \</span><br><span class="line">		   <span class="string">"fi; "</span> \</span><br><span class="line">	   <span class="string">"else "</span> \</span><br><span class="line">			SYSTEM_RESET_CMD \</span><br><span class="line">	   <span class="string">"fi"</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>以增加u-boot启动时对双系统引导、失败后重试、自动修改待引导系统分区等的支持。</p>
<h3 id="Linux上对修改u-boot环境变量的支持"><a href="#Linux上对修改u-boot环境变量的支持" class="headerlink" title="Linux上对修改u-boot环境变量的支持"></a>Linux上对修改u-boot环境变量的支持</h3><p>在上文中提到，完成升级后，若要实现复位后从新分区启动的目的，需要在Linux上对u-boot的环境变量boot_bank进行修改。而u-boot的环境变量存储在裸分区，只有在u-boot下使用setenv命令对其进行修改。若在Linux上对其进行修改，需要使用到u-boot提供的工具<code>fw_setenv</code>。该工具的源码在u-boot目录tools/env下，需要对其进行修改，以符合本方案使用的硬件平台（s32v234sbc）。需对<code>tools/env/fw_env_private.h</code>文件进行修改，修改方案如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//#define CONFIG_FILE     "/etc/fw_env.config"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_FILE</span></span><br><span class="line"><span class="comment">//#define HAVE_REDUND /* For systems with 2 env sectors */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE1_NAME      <span class="meta-string">"/dev/mmcblk0"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE2_NAME      <span class="meta-string">"/dev/mtd2"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE1_OFFSET    0xC0000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ENV1_SIZE         0x2000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE1_ESIZE     0x4000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE1_ENVSECTORS     2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE2_OFFSET    0x0000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ENV2_SIZE         0x4000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE2_ESIZE     0x4000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE2_ENVSECTORS     2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li>注释掉宏定义<code>CONFIG_FILE</code>，采用静态配置</li>
<li><code>DEVICE1_NAME</code>为实际的device名</li>
<li><code>DEVICE1_OFFSET</code>和<code>ENV1_SIZE</code>需要根据<code>include/configs/s32.h</code>中的相关配置进行修改，查找其相关配置如下：<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_SYS_NO_FLASH</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_ENV_SIZE			(0x2000) <span class="comment">/* 8 KB */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_ENV_OFFSET		(0xC0000) <span class="comment">/* 12 * 64 * 1024 */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_SYS_MMC_ENV_DEV		0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_MMC_PART			1</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>如上对<code>fw_setenv</code>源文件进行修改后执行编译命令：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make CROSS_COMPILE=&lt;your cross-compiler prefix&gt; envtools</span><br></pre></td></tr></table></figure>

<p>可得到工具<code>fw_printenv</code>的可执行文件，然后执行：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s fw_printenv fw_setenv</span><br></pre></td></tr></table></figure>

<p>即可得到u-boot环境变量修改工具，从而可实现在Linux下修改u-boot环境变量。</p>


<!--<a href="http://www.howar.cn/2020/02/05/AB-system/#disqus_thread" class="article-comment-link">Comments</a>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = ''; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
-->
<div style="display:none">
<script src="http://s4.cnzz.com/stat.php?id=&web_id=" language="JavaScript"></script>script>
</div>






</body>
</html>