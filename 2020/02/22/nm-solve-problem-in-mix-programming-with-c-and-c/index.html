<html>
<head><meta name="generator" content="Hexo 3.9.0">
	
	<title>用nm工具定位C/C++混合编程中的链接问题</title>
	<meta name="keywords" content="howar.cn">

    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
	   <link href="/css/main.css?v=3" rel="stylesheet" type="text/css">
    
        <script src="/js/util.js"></script>
        <script>
            if(isMobile()) {
                loadjscssfile('../css/mobile.css', 'css');
            } else {
                loadjscssfile('../css/desktop.css', 'css');
            }
        </script> 
    

    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">

    
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=3">
    
    
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-159646423-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>


<h2 class="title">用nm工具定位C/C++混合编程中的链接问题</h2>
<!---
<div style="text-align:center;margin-top: -10px;">
<div class="article-category">
发表于2020年2月22日




 </div>
--->
</div>

<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#什么是C-C-混合编程"><span class="toc-text">什么是C/C++混合编程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#C-项目使用了C的第三方库"><span class="toc-text">C++项目使用了C的第三方库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#C项目使用了C-的第三方库"><span class="toc-text">C项目使用了C++的第三方库</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#C-C-混合编程会遇到什么链接问题"><span class="toc-text">C/C++混合编程会遇到什么链接问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用nm工具定位上述问题"><span class="toc-text">使用nm工具定位上述问题</span></a></li></ol>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在实际工作中，难免会用到第三方库，而有时候第三库所采用的编程语言可能跟我们项目中实际使用的语言不一致，比如C++项目使用了C的第三方库，或者C项目使用了C++的第三方库。这种情况就需要处理C/C++混合编程的问题。</p>
<h2 id="什么是C-C-混合编程"><a href="#什么是C-C-混合编程" class="headerlink" title="什么是C/C++混合编程"></a>什么是C/C++混合编程</h2><h3 id="C-项目使用了C的第三方库"><a href="#C-项目使用了C的第三方库" class="headerlink" title="C++项目使用了C的第三方库"></a>C++项目使用了C的第三方库</h3><p>有C文件<code>foo.c</code>，其内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"This is foo function\n"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对应的头文件为<code>foo.h</code>，其内容为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _FOO_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _FOO_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _FOO_H_ */</span></span></span><br></pre></td></tr></table></figure>

<p>先通过以下指令将其编译成静态库：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -c foo.c</span><br><span class="line">ar -r libfoo.a foo.o</span><br></pre></td></tr></table></figure>

<p><code>main.cpp</code>中调用<code>foo.c</code>内的函数，<code>main.cpp</code>的内容如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"foo.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    foo();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用以下命令编译<code>main.cpp</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ main.cpp -L. -lfoo -o a.out</span><br></pre></td></tr></table></figure>

<p>以上，实现C++对C的调用。</p>
<h3 id="C项目使用了C-的第三方库"><a href="#C项目使用了C-的第三方库" class="headerlink" title="C项目使用了C++的第三方库"></a>C项目使用了C++的第三方库</h3><p>有CPP文件<code>foo.cpp</code>，其内容如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"This is foo function"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>对应的头文件为<code>foo.h</code>，其内容为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _FOO_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _FOO_H_</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _FOO_H_ */</span></span></span><br></pre></td></tr></table></figure>

<p>先通过以下指令将其编译成静态库：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -c foo.cpp</span><br><span class="line">ar -r libfoo.a foo.o</span><br></pre></td></tr></table></figure>

<p><code>main.c</code>中调用<code>foo.cpp</code>内的函数，<code>main.c</code>的内容如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"foo.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    foo();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用以下命令编译<code>main.c</code>:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc main.c -L. -lfoo -o a.out -lstdc++</span><br></pre></td></tr></table></figure>

<p>以上，实现C对C++的调用。</p>
<blockquote>
<p>注意要加上<code>-lstdc++</code>，因为用gcc编译c++程序时，链接的库文件为libstdc++.so，而不是默认的libc.so，因此需要用-lstdc++参数指明，否则会在链接时发生错误。</p>
</blockquote>
<h2 id="C-C-混合编程会遇到什么链接问题"><a href="#C-C-混合编程会遇到什么链接问题" class="headerlink" title="C/C++混合编程会遇到什么链接问题"></a>C/C++混合编程会遇到什么链接问题</h2><p>通过上面的例子可以看到，都在合适的位置加上了如下代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>为什么呢？<br><br>因为C只有单一的命名空间，不支持函数重载之类的特性，例如对于函数void fun(int a, int b)，经过编译后生成的符号为_fun，C链接器链接的时候就会去找_fun这样的函数符号；C++为了支持函数重载（即函数名字可以相同，参数类型或个数不同），允许存在同名的函数，这一点在C中是做不到的。其实，C++甚至可以存在相同的类型、变量等，因为在C++中命名空间的存在。在C++中，对于函数void fun(int a, int b)，经过编译后，生成的类似为_fun_int_int，新生成的符号名不仅带有函数名，还有参数类型。正因为他们两者编译函数的时候，生成的符号规则不一样，所以，在混合编程中，如果我们不进行任何处理，而相互效用的话，必然会出现在链接的时候，找不到符号链接的情况。</p>
<ul>
<li>在C++调用C的情况中，可以在C对应的头文件中加入<code>extern &quot;C&quot;</code>，从而在编译C++代码时，可以告诉编译器按照C链接器的规则去查找相关函数。</li>
<li>在C调用C++的情况中，可以在C++的源文件中加入<code>extern &quot;C&quot;</code>，这样在编译C++对应接口的时候，就告诉编译器按照C链接器的规则去生成相关函数符号。此场景中对于一些复杂的情况，可能还需要增加一些包裹接口(wrapper)来封装相关C++接口，这里不作详细讨论。</li>
</ul>
<p>由于C/C++编译器生成符号的规则不一样，从而导致C/C++混合编程时可能会出现”undefined reference to XXX”的问题。</p>
<h2 id="使用nm工具定位上述问题"><a href="#使用nm工具定位上述问题" class="headerlink" title="使用nm工具定位上述问题"></a>使用nm工具定位上述问题</h2><p>这里以上述<em>C项目使用了C++的第三方库</em>的代码为例，去掉文件<code>foo.cpp</code>中有关<code>extern &quot;C&quot;</code>的代码，然后用同样的方式进行编译，会出现以下问题：<br><img src="/images/nm/nm-fault.png" width="842" height="117" align="center"><br>使用<code>nm</code>工具查看<code>foo.o</code>结果如下：<br><img src="/images/nm/nm-result.png" width="704" height="225" align="center"><br>可以明显看出来函数<code>foo</code>对应的符号是C++形式的。</p>
<p>而出现上述问题，通常有两个原因：</p>
<ol>
<li>没有在合适的地方加上<code>extern &quot;C&quot;</code></li>
<li>函数定义和函数声明不一致（比如参数类型不一致）</li>
</ol>
<p>这两种情况都可通过<code>nm</code>工具作排查。</p>


<!--<a href="http://www.howar.cn/2020/02/22/nm-solve-problem-in-mix-programming-with-c-and-c/#disqus_thread" class="article-comment-link">Comments</a>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = ''; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
-->
<div style="display:none">
<script src="http://s4.cnzz.com/stat.php?id=&web_id=" language="JavaScript"></script>script>
</div>






</body>
</html>