<html>
<head><meta name="generator" content="Hexo 3.9.0">
	
	<title>linux进程、线程和调度(三)</title>
	<meta name="keywords" content="howar.cn">

    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
	   <link href="/css/main.css?v=3" rel="stylesheet" type="text/css">
    
        <script src="/js/util.js"></script>
        <script>
            if(isMobile()) {
                loadjscssfile('../css/mobile.css', 'css');
            } else {
                loadjscssfile('../css/desktop.css', 'css');
            }
        </script> 
    

    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">

    
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=3">
    
    

</head>

<body>


<h2 class="title">linux进程、线程和调度(三)</h2>
<!---
<div style="text-align:center;margin-top: -10px;">
<div class="article-category">
发表于2018年7月22日


    <a class="article-category-link" href="/categories/Linux/">Linux</a>



 </div>
--->
</div>

<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#吞吐率-vs-响应"><span class="toc-text">吞吐率 vs. 响应</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#I-O消耗型-vs-CPU消耗型"><span class="toc-text">I/O消耗型 vs. CPU消耗型</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux任务调度机制"><span class="toc-text">Linux任务调度机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#早期2-6任务调度机制"><span class="toc-text">早期2.6任务调度机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#优先级数组和Bitmaps"><span class="toc-text">优先级数组和Bitmaps</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SCHED-FIFO、SCHED-RR"><span class="toc-text">SCHED_FIFO、SCHED_RR</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SCHED-NORMAL"><span class="toc-text">SCHED_NORMAL</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#当前Linux任务调度机制"><span class="toc-text">当前Linux任务调度机制</span></a></li></ol></li></ol>
<h2 id="吞吐率-vs-响应"><a href="#吞吐率-vs-响应" class="headerlink" title="吞吐率 vs. 响应"></a>吞吐率 vs. 响应</h2><p>计算机系统的总体性能标准是响应时间和吞吐量。</p>
<p>响应时间是提交请求和返回该请求的响应之间使用的时间。<br><br>示例包括：</p>
<ul>
<li>数据库查询花费的时间</li>
<li>将字符回显到终端上花费的时间</li>
<li>访问 Web 页面花费的时间</li>
</ul>
<p>吞吐量是对单位时间内完成的工作量的量度。<br><br>示例包括：</p>
<ul>
<li>每分钟的数据库事务</li>
<li>每秒传送的文件千字节数</li>
<li>每秒读或写的文件千字节数</li>
<li>每分钟的 Web 服务器命中数<br>这些度量之间的关系很复杂。有时可能以响应时间为代价而得到较高的吞吐量，而有时候又要以吞吐量为代价得到较好的响应时间。在其他情况下，一个单独的更改可能对两者都有提高。可接受的性能基于合理的吞吐量与合理的响应时间相结合。</li>
</ul>
<p>吞吐和响应之间的矛盾:<br></p>
<ul>
<li>响应 : 最小化某个任务的响应时间，哪怕牺牲其他的任务为代价</li>
<li>吞吐: 全局视野，整个系统的workload被最大化处理</li>
</ul>
<h4 id="I-O消耗型-vs-CPU消耗型"><a href="#I-O消耗型-vs-CPU消耗型" class="headerlink" title="I/O消耗型 vs. CPU消耗型"></a>I/O消耗型 vs. CPU消耗型</h4><ul>
<li>IO bound: CPU利用率低，进程的运行效率主要受限于I/O速度。主要关注是否能被及时调度到，不关注CPU是否强劲。</li>
<li>CPU bound: 多数时间花在CPU上面(做运算)。主要关注CPU是否强劲。<blockquote>
<p>ARM架构中的<code>big.LITTLE</code>就是基于这种考虑：将I/O消耗型任务放到小核上执行，将CPU消耗型任务放到大核上执行。这样可以最大限度的利用CPU的性能。</p>
</blockquote>
</li>
</ul>
<h2 id="Linux任务调度机制"><a href="#Linux任务调度机制" class="headerlink" title="Linux任务调度机制"></a>Linux任务调度机制</h2><p>通用Linux系统支持实时和非实时两种进程，实时进程相对于普通进程具有绝对的优先级。对应地，实时进程采用SCHED_FIFO或者SCHED_RR调度策略，普通的进程采用SCHED_OTHER调度策略。</p>
<h3 id="早期2-6任务调度机制"><a href="#早期2-6任务调度机制" class="headerlink" title="早期2.6任务调度机制"></a>早期2.6任务调度机制</h3><h4 id="优先级数组和Bitmaps"><a href="#优先级数组和Bitmaps" class="headerlink" title="优先级数组和Bitmaps"></a>优先级数组和Bitmaps</h4><p>首先看下面这幅图：<br><br><img src="https://github.com/howar-luo/image_repo/blob/master/20180801/task_bitmap.png?raw=true" width="90%" height><br><br>早起操作系统有一个140个元素的bitmap，其中0-99是给实时任务的，100-139是给普通任务的。</p>
<h4 id="SCHED-FIFO、SCHED-RR"><a href="#SCHED-FIFO、SCHED-RR" class="headerlink" title="SCHED_FIFO、SCHED_RR"></a>SCHED_FIFO、SCHED_RR</h4><p>SCHED_FIFO：不同优先级按照优先级高的先跑到睡眠，优先级低的再跑；同等优先级先进先出。</p>
<p>SCHED_RR：不同优先级按照优先级高的先跑到睡眠，优先级低的再跑；同等优先级轮转。</p>
<p>在不同优先级的情况下，这两者的表现是一样的，即高优先级的任务先跑，直到高优先级的任务睡眠，低优先级的任务再跑。</p>
<p>在相同优先级的情况下，这两种任务调度策略是有区别的：SCHED_FIFO会才有先进先出的原则进行调度，即先ready的任务跑到休眠后，才调度后ready的任务；而SCHED_RR则会轮转调度所有ready的任务，你执行一下我执行一下。</p>
<h4 id="SCHED-NORMAL"><a href="#SCHED-NORMAL" class="headerlink" title="SCHED_NORMAL"></a>SCHED_NORMAL</h4><p>普通任务的调度策略采用SCHED_NORMAL，不同优先级的任务进行轮转。普通任务的优先级为100-139，但是普通任务的优先级高并不会相比低优先级的任务有绝对的优势，有两个优势：可以得到更高的时间片；醒来后可以抢占低优先级任务。普通任务调度将优先级转化为nice值（-20-19）。</p>
<p>在运行过程中，会根据任务的睡眠情况对nice进行奖励和惩罚。任务越喜欢睡觉，系统就会越奖励；任务越喜欢运行，系统就会越惩罚。这样做的目的是想让I/O消耗型的任务在和CPU消耗型的任务竞争的过程中，能够很好的竞争。</p>
<blockquote>
<p>在Linux后期发展过程中，增加了补丁，从而限制了实时任务最大的运行时间占用率(95%)，即实时任务即使不主动放弃CPU，系统至少还会分配5%的CPU给普通进程。</p>
</blockquote>
<h3 id="当前Linux任务调度机制"><a href="#当前Linux任务调度机制" class="headerlink" title="当前Linux任务调度机制"></a>当前Linux任务调度机制</h3><p>Linux在发展过程中，SCHED_FIFO和SCHED_RR变化并不大，主要变化的是SCHED_NORMAL。</p>
<p>现在的SCHED_NORAML最著名的当数CFS了，CFS使用红黑树的数据结构，如下图：<br><br><img src="https://github.com/howar-luo/image_repo/blob/master/20180802/CFS.png?raw=true" width="90%" height><br><br>在上述红黑树中，左边节点小于右边节点的值，系统总是选择树的最左边的节点进行调度。</p>
<p>其中，节点上的数字代表是的是进程运行到目前为止的vruntime，即进程多的虚拟运行时间。其计算公式可以简单按下式理解：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vruntime += delta* NICE_0_LOAD/ se.weight</span><br></pre></td></tr></table></figure>

<p>其中：<br><br><code>delta</code>为实际运行时间<br><code>NICE_0_LOAD</code>为标准值1024<br><code>se.weight</code>为权重，如下图所示:<br><br><img src="https://github.com/howar-luo/image_repo/blob/master/20180805/nice_weight.png?raw=true" width="90%" height><br></p>


<!--<a href="http://www.howar.cn/2018/07/22/linux-process-3/#disqus_thread" class="article-comment-link">Comments</a>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = ''; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
-->
<div style="display:none">
<script src="http://s4.cnzz.com/stat.php?id=&web_id=" language="JavaScript"></script>script>
</div>






</body>
</html>